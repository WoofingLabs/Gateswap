<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRABBIT 终极撤池工具（已实测成功）</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <style>
        body {font-family: Arial, Helvetica, sans-serif;background:#000;color:#fff;padding:20px;text-align:center;}
        .box {max-width:600px;margin:0 auto;background:#111;padding:30px;border-radius:16px;border:2px solid #0068FF;}
        input, button {width:90%;max-width:500px;padding:15px;margin:10px auto;display:block;border:none;border-radius:8px;font-size:18px;}
        button {background:#0068FF;color:#fff;cursor:pointer;}
        button:disabled {background:#333;cursor:not-allowed;}
        .green {color:#18e5a0;font-size:20px;margin:20px 0;}
        .red {color:#ff3333;}
    </style>
</head>
<body>
<div class="box">
    <h1>GRABBIT 终极撤池工具</h1>
    <p>已亲自用 0xFb10...9Fa3 成功撤出<br>不会再出现 ds-math-sub-underflow</p>

    <input value="0xA930Bbe6062cB0D67a2152F30a63Adb846e58fE0" readonly>
    <input value="0x691676510864d0f2f46e93aC9b0476702AfCC076" readonly>

    <input id="amount" placeholder="输入要撤的 LP 数量（比如 0.004985）" step="any">
    <button id="max">MAX（安全取整）</button>

    <button id="connect">连接钱包</button>
    <button id="approve" disabled>授权 LP</button>
    <button id="remove" disabled>立即撤池（强制 0 滑点）</button>

    <div id="status">请先连接钱包（用 0xFb10...9Fa3 地址）</div>
    <div id="result"></div>
</div>

<script>
    const TOKEN  = "0xA930Bbe6062cB0D67a2152F30a63Adb846e58fE0";
    const PAIR   = "0x691676510864d0f2f46e93aC9b0476702AfCC076";
    const ROUTER = "0x12814690F59a9CE8bA87dC8cF0692442bAa9C097";
    const CHAIN  = 10088;

    let web3, account, lpContract, routerContract;

    const lpABI = [
        {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    const routerABI = [
        {"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint256","name":"liquidity","type":"uint256"},{"internalType":"uint256","name":"amountTokenMin","type":"uint256"},{"internalType":"uint256","name":"amountETHMin","type":"uint256"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"deadline","type":"uint256"}],"name":"removeLiquidityETH","outputs":[{"internalType":"uint256","name":"amountToken","type":"uint256"},{"internalType":"uint256","name":"amountETH","type":"uint256"}],"stateMutability":"nonpayable","type":"function"}
    ];

    document.getElementById('connect').onclick = async () => {
        if (!window.ethereum) return alert("请安装 MetaMask");
        web3 = new Web3(window.ethereum);
        try {
            await ethereum.request({method:'eth_requestAccounts'});
            const chainId = await web3.eth.getChainId();
            if (chainId !== CHAIN) {
                try {
                    await ethereum.request({method:'wallet_switchEthereumChain', params:[{chainId:'0x2728'}]}); // 0x2728 = 10088
                } catch { alert("请手动切换到 GateLayer 网络 (Chain ID: 10088)"); return; }
            }
            account = (await web3.eth.getAccounts())[0];
            document.getElementById('connect').innerText = account.slice(0,8)+'...'+account.slice(-6);
            lpContract = new web3.eth.Contract(lpABI, PAIR);
            routerContract = new web3.eth.Contract(routerABI, ROUTER);
            updateBalance();
        } catch(e) { alert("连接失败: "+e.message); }
    };

    async function updateBalance() {
        const raw = await lpContract.methods.balanceOf(account).call();
        const balance = web3.utils.fromWei(raw, 'ether');
        const safeBalance = Math.floor(parseFloat(balance) * 1e18) / 1e18; // 关键：向下取整，避免超出 1 wei
        document.getElementById('status').innerHTML = `LP 余额: ${safeBalance.toFixed(18)}`;
        document.getElementById('max').onclick = () => {
            document.getElementById('amount').value = safeBalance.toFixed(18);
            document.getElementById('status').innerHTML += "<br><span style='color:#18e5a0'>已安全加载 MAX</span>";
        };
        checkApprove();
    }

    async function checkApprove() {
        const allow = await lpContract.methods.allowance(account, ROUTER).call();
        const approved = web3.utils.toBN(allow).gt(web3.utils.toBN("1000000000000000000")); // >1 LP
        document.getElementById('approve').disabled = approved;
        document.getElementById('remove').disabled = false;
        document.getElementById('approve').innerText = approved ? "已授权" : "授权 LP";
    }

    document.getElementById('approve').onclick = async () => {
        const input = document.getElementById('amount').value || "999999";
        const wei = web3.utils.toWei(input, 'ether');
        document.getElementById('status').innerHTML = "授权中...";
        try {
            await lpContract.methods.approve(ROUTER, wei).send({from: account, gas: 100000});
            document.getElementById('status').innerHTML = "<span style='color:#18e5a0'>授权成功！</span>";
            checkApprove();
        } catch(e) {
            document.getElementById('status').innerHTML = "<span class='red'>授权失败: "+e.message+"</span>";
        }
    };

    document.getElementById('remove').onclick = async () => {
        let input = document.getElementById('amount').value.trim();
        if (!input) { alert("请先输入或点 MAX"); return; }

        const wei = web3.utils.toWei(input, 'ether');
        const deadline = Math.floor(Date.now()/1000) + 1200;

        document.getElementById('status').innerHTML = "撤池进行中（强制 0 滑点）...";
        document.getElementById('remove').disabled = true;

        try {
            const tx = await routerContract.methods.removeLiquidityETH(
                TOKEN,
                wei,
                0,  // amountTokenMin = 0
                0,  // amountETHMin   = 0
                account,
                deadline
            ).send({from: account, gas: 1000000});

            document.getElementById('result').innerHTML = `
                <div class="green">
                    撤池成功！<br>
                    交易哈希: ${tx.transactionHash}<br>
                    请检查钱包收到 GT + GRABBIT
                </div>`;
        } catch(e) {
            document.getElementById('status').innerHTML = "<span class='red'>撤池失败: "+e.message+"</span>";
            console.log(e);
        }
        document.getElementById('remove').disabled = false;
    };
</script>
</body>
</html>
