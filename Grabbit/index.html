<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GRABBIT 一键撤池</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <style>
        body{font-family:Arial;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}
        .box{max-width:420px;width:90%;background:#111;padding:30px;border-radius:20px;box-shadow:0 0 30px #0068ff;border:1px solid #0068ff}
        h1{font-size:28px;text-align:center;margin:0 0 20px;color:#00ffff}
        .info{background:#222;padding:10px;border-radius:8px;margin:10px 0;font-family:monospace;font-size:13px;word-break:break-all}
        input{width:100%;padding:14px;box-sizing:border-box;background:#222;border:1px solid #444;border-radius:8px;color:#fff;margin:15px 0;font-size:16px}
        button{width:100%;padding:16px;background:#f1404b;border:none;border-radius:12px;color:#fff;font-size:18px;font-weight:bold;cursor:pointer;margin:10px 0}
        button:hover{background:#ff1744}
        button:disabled{background:#333;cursor:not-allowed}
        #status{margin-top:15px;text-align:center;min-height:24px;font-size:14px}
        .maxbtn{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:#00ffff;color:#000;padding:8px 12px;border-radius:6px;font-weight:bold;font-size:12px}
        .amt{position:relative}
    </style>
</head>
<body>
<div class="box">
    <h1>GRABBIT 撤池神器</h1>
    <div class="info">Token: 0xA930Bbe6062cB0D67a2152F30a63Adb846e58fE0</div>
    <div class="info">Pair : 0x691676510864d0f2f46e93aC9b0476702AfCC076</div>
    <div class="info">WGT  : 0x6803b8E93b13941F6B73b82E324B80251B3dE338</div>
    <div class="info">Router: 0x12814690F59a9CE8bA87dC8cF0692442bAa9C097</div>

    <div class="amt">
        <input id="amount" placeholder="LP 数量（留空 = 全撤）">
        <div class="maxbtn" onclick="setMax()">MAX</div>
    </div>

    <div style="text-align:center;color:#888;margin:10px 0">
        你的 LP 余额: <span id="lpBalance">0</span>
    </div>

    <button id="connectBtn" onclick="connect()">连接钱包（GateLayer）</button>
    <button id="removeBtn" onclick="removeLiquidity()" disabled>立即撤池（支持带税代币）</button>

    <div id="status"></div>
</div>

<script>
// 固定参数
const TOKEN   = "0xA930Bbe6062cB0D67a2152F30a63Adb846e58fE0";
const PAIR    = "0x691676510864d0f2f46e93aC9b0476702AfCC076";
const WGT     = "0x6803b8E93b13941F6B73b82E324B80251B3dE338";
const ROUTER  = "0x12814690F59a9CE8bA87dC8cF0692442bAa9C097";

const routerABI = [{"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint256","name":"liquidity","type":"uint256"},{"internalType":"uint256","name":"amountTokenMin","type":"uint256"},{"internalType":"uint256","name":"amountETHMin","type":"uint256"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"deadline","type":"uint256"}],"name":"removeLiquidityETHSupportingFeeOnTransferTokens","outputs":[{"internalType":"uint256","name":"amountETH","type":"uint256"}],"stateMutability":"nonpayable","type":"function"}];

const erc20ABI = [{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];

let web3, account, router, pairContract;

async function connect(){
    if(!window.ethereum) return alert("请安装 MetaMask");
    web3 = new Web3(window.ethereum);
    try{
        await ethereum.request({method:'eth_requestAccounts'});
        account = (await web3.eth.getAccounts())[0];

        // 自动切换到 GateLayer
        try{
            await ethereum.request({method:'wallet_switchEthereumChain', params:[{chainId:'0x2728'}]}); // 10088 = 0x2728
        }catch(e){
            if(e.code===4902){
                await ethereum.request({method:'wallet_addEthereumChain', params:[{
                    chainId:'0x2728',
                    chainName:'GateLayer',
                    rpcUrls:['https://gatelayer-mainnet.gatenode.cc'],
                    nativeCurrency:{name:'GT',symbol:'GT',decimals:18},
                    blockExplorerUrls:['https://www.gatescan.org/gatelayer/']
                }]});
            }
        }

        router = new web3.eth.Contract(routerABI, ROUTER);
        pairContract = new web3.eth.Contract(erc20ABI, PAIR);

        document.getElementById("connectBtn").innerText = account.slice(0,8)+"..."+account.slice(-6);
        document.getElementById("removeBtn").disabled = false;
        updateBalance();
        setInterval(updateBalance, 6000);
    }catch(e){ document.getElementById("status").innerText = "连接失败: "+e.message; }
}

async function updateBalance(){
    if(!account) return;
    try{
        const b = await pairContract.methods.balanceOf(account).call();
        const f = Number(web3.utils.fromWei(b,'ether')).toFixed(6);
        document.getElementById("lpBalance").innerText = f;
    }catch(e){}
}

function setMax(){
    const cur = document.getElementById("lpBalance").innerText;
    if(cur!=="0") document.getElementById("amount").value = cur;
}

async function removeLiquidity(){
    let amount = document.getElementById("amount").value.trim();
    if(!amount) amount = document.getElementById("lpBalance").innerText;
    if(!amount || Number(amount)<=0) return alert("数量无效");

    const status = document.getElementById("status");
    status.innerText = "正在授权 LP...";
    document.getElementById("removeBtn").disabled = true;

    try{
        // 1. 授权
        await pairContract.methods.approve(ROUTER, web3.utils.toWei(amount,'ether')).send({from:account});
        status.innerText = "授权成功，正在撤池（支持带税）...";

        // 2. 撤池（关键：用 SupportingFeeOnTransferTokens 版本）
        const deadline = Math.floor(Date.now()/1000) + 1800;
        await router.methods.removeLiquidityETHSupportingFeeOnTransferTokens(
            TOKEN,
            web3.utils.toWei(amount,'ether'),
            0,               // 接受任意数量 GRABBIT（因为有税）
            0,               // 接受任意数量 WGT
            account,
            deadline
        ).send({from:account, gas:900000});

        status.innerHTML = `<span style="color:#0f0">撤池成功！GRABBIT + WGT 已到账</span>`;
        updateBalance();
        document.getElementById("amount").value = "";
    }catch(e){
        status.innerText = e.message.includes("User denied") ? "用户取消交易" : "失败: "+e.message;
    }
    document.getElementById("removeBtn").disabled = false;
}
</script>
</body>
</html>
