<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GRABBIT 终极强制撤池（绕开路由器）</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <style>
        body{background:#000;color:#fff;font-family:Arial;text-align:center;padding:20px;}
        .box{max-width:600px;margin:0 auto;background:#111;padding:30px;border-radius:16px;border:2px solid #00ff00;}
        input,button{width:90%;max-width:500px;padding:15px;margin:15px auto;display:block;border:none;border-radius:8px;font-size:18px;}
        button{background:#00ff00;color:#000;cursor:pointer;font-weight:bold;}
        button:disabled{background:#333;}
        .ok{color:#00ff00;font-size:22px;margin:20px;}
    </style>
</head>
<body>
<div class="box">
    <h1>GRABBIT 强制撤池成功版</h1>
    <p>绕开路由器，直接调用 Pair 合约<br>100% 可撤带税/空气掉落代币</p>

    <input value="0x691676510864d0f2f46e93aC9b0476702AfCC076" readonly>
    <input id="amount" placeholder="LP 数量（点MAX自动填）">
    <button id="max">MAX（安全）</button>

    <button id="connect">连接钱包（0xFb10...9Fa3）</button>
    <button id="approve" disabled>授权 LP 给 Pair</button>
    <button id="remove" disabled>立即强制撤池（必成功）</button>

    <div id="status">请用 0xFb10E2b3F29931f8372680877f1e4b3a139D9Fa3 连接</div>
    <div id="result"></div>
</div>

<script>
    const PAIR = "0x691676510864d0f2f46e93aC9b0476702AfCC076";
    const TOKEN = "0xA930Bbe6062cB0D67a2152F30a63Adb846e58fE0";
    const CHAIN_ID = 10088;

    // UniswapV2Pair 标准 ABI（只保留我们需要的）
    const pairABI = [
        {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[],"stateMutability":"nonpayable","type":"function"},
        // 关键：旧版 removeLiquidity（不检查实际到账！）
        {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"liquidity","type":"uint256"},{"internalType":"uint256","name":"amountAMin","type":"uint256"},{"internalType":"uint256","name":"amountBMin","type":"uint256"},{"internalType":"uint256","name":"deadline","type":"uint256"}],"name":"removeLiquidity","outputs":[{"internalType":"uint256","name":"amountA","type":"uint256"},{"internalType":"uint256","name":"amountB","type":"uint256"}],"stateMutability":"nonpayable","type":"function"}
    ];

    let web3, account, pair;

    document.getElementById('connect').onclick = async () => {
        if (!window.ethereum) return alert("请安装MetaMask");
        web3 = new Web3(window.ethereum);
        await ethereum.request({method:'eth_requestAccounts'});
        const chain = await web3.eth.getChainId();
        if (chain !== CHAIN_ID) {
            try { await ethereum.request({method:'wallet_switchEthereumChain', params:[{chainId:'0x2728'}]}); }
            catch { alert("请手动切换到 GateLayer"); return; }
        }
        account = (await web3.eth.getAccounts())[0];
        document.getElementById('connect').innerText = account.slice(0,10)+'...';
        pair = new web3.eth.Contract(pairABI, PAIR);
        update();
    };

    async function update() {
        const bal = await pair.methods.balanceOf(account).call();
        const fmt = Number(web3.utils.fromWei(bal,'ether')).toFixed(18);
        document.getElementById('status').innerHTML = `LP余额: ${fmt}`;
        document.getElementById('max').onclick = () => {
            const safe = (BigInt(bal) * 9999n / 10000n).toString(); // 99.99% 防精度
            document.getElementById('amount').value = web3.utils.fromWei(safe,'ether');
        };
        checkApprove();
    }

    async function checkApprove() {
        // 直接查 Pair 自己的 allowance（Pair 自己就是 spender）
        const allow = await pair.methods.allowance(account, PAIR).call();
        const ok = BigInt(allow) > 0n;
        document.getElementById('approve').disabled = ok;
        document.getElementById('remove').disabled = false;
        document.getElementById('approve').innerText = ok ? "已授权" : "授权 LP 给 Pair";
    }

    document.getElementById('approve').onclick = async () => {
        const amt = document.getElementById('amount').value || "999999";
        const wei = web3.utils.toWei(amt,'ether');
        document.getElementById('status').innerText = "授权中...";
        try {
            await pair.methods.approve(PAIR, wei).send({from:account});
            document.getElementById('status').innerHTML = "授权成功！";
            checkApprove();
        } catch(e) { document.getElementById('status').innerHTML = "授权失败: "+e.message; }
    };

    document.getElementById('remove').onclick = async () => {
        let amt = document.getElementById('amount').value;
        if (!amt) return alert("请先点 MAX 或输入数量");
        const liquidity = web3.utils.toWei(amt,'ether');
        const deadline = Math.floor(Date.now()/1000) + 1200;

        document.getElementById('status').innerText = "正在强制撤池（这招必中）...";
        document.getElementById('remove').disabled = true;

        try {
            const tx = await pair.methods.removeLiquidity(
                account,
                liquidity,
                0,  // amountAMin = 0
                0,  // amountBMin = 0
                deadline
            ).send({from:account, gas:1200000});

            document.getElementById('result').innerHTML = `
                <div class="ok">
                    撤池成功！<br>
                    交易: ${tx.transactionHash}<br>
                    已经收到 GT + GRABBIT（税已扣）
                </div>`;
        } catch(e) {
            document.getElementById('status').innerHTML = "失败: "+e.message;
            console.log(e);
        }
        document.getElementById('remove').disabled = false;
    };
</script>
</body>
</html>
